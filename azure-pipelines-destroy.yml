# Terraform DESTROY pipeline
# Kontrollált infra törlés manuális approval-val

trigger: none

pool:
  vmImage: ubuntu-latest

variables:
- name: AWS_REGION
  value: eu-central-1
- name: TF_WORKING_DIR
  value: terraform
- group: aws-lab-credentials

jobs:
- deployment: terraform_destroy
  displayName: "Terraform destroy (manual approval)"
  environment: infra-approval
  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: self

        # 1️⃣ Terraform telepítése
        - task: TerraformInstaller@1
          displayName: "Install Terraform"
          inputs:
            terraformVersion: "1.6.6"

        # 2️⃣ Terraform init
        - bash: |
            terraform init -upgrade
          displayName: "Terraform init"
          workingDirectory: $(TF_WORKING_DIR)
          env:
            AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
            AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
            AWS_DEFAULT_REGION: $(AWS_REGION)

        # 3️⃣ Terraform destroy
        - bash: |
            terraform destroy -auto-approve
          displayName: "Terraform destroy"
          workingDirectory: $(TF_WORKING_DIR)
          env:
            AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
            AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
            AWS_DEFAULT_REGION: $(AWS_REGION)
            TF_VAR_ecr_image_uri: $(ECR_IMAGE_URI)
