trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  TF_VERSION: "1.6.6"
  TF_WORKING_DIR: "terraform"

stages:
# =========================
# Terraform PLAN
# =========================
- stage: Terraform_Plan
  displayName: "Terraform – Plan"
  jobs:
  - job: terraform_plan
    displayName: "Terraform Plan"
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: $(TF_VERSION)

    - bash: |
        terraform init
      displayName: "Terraform Init"
      workingDirectory: $(TF_WORKING_DIR)

    # -------------------------
    # DEBUG – variable check
    # -------------------------
    - bash: |
        echo "ECR_IMAGE_URI from pipeline: $ECR_IMAGE_URI"
        echo "TF_VAR_ecr_image_uri: $TF_VAR_ecr_image_uri"
      displayName: "DEBUG variables"
      workingDirectory: $(TF_WORKING_DIR)
      env:
        ECR_IMAGE_URI: $(ECR_IMAGE_URI)
        TF_VAR_ecr_image_uri: $(ECR_IMAGE_URI)

    # -------------------------
    # Terraform Plan (NON-interactive)
    # -------------------------
    - bash: |
        terraform plan -input=false
      displayName: "Terraform Plan"
      workingDirectory: $(TF_WORKING_DIR)
      env:
        TF_VAR_ecr_image_uri: $(ECR_IMAGE_URI)

# =========================
# Terraform APPLY (Manual Approval)
# =========================
- stage: Terraform_Apply
  displayName: "Terraform – Apply (Manual Approval)"
  dependsOn: Terraform_Plan
  condition: succeeded()
  jobs:
  - deployment: terraform_apply
    displayName: "Terraform Apply"
    environment: infra-approval
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: TerraformInstaller@1
            displayName: "Install Terraform"
            inputs:
              terraformVersion: $(TF_VERSION)

          - bash: |
              terraform init
            displayName: "Terraform Init"
            workingDirectory: $(TF_WORKING_DIR)

          - bash: |
              terraform apply -input=false -auto-approve
            displayName: "Terraform Apply"
            workingDirectory: $(TF_WORKING_DIR)
            env:
              TF_VAR_ecr_image_uri: $(ECR_IMAGE_URI)
