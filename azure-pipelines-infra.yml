trigger: none

parameters:
  - name: imageTag
    displayName: "ECR image tag to deploy (leave empty for latest)"
    type: string
    default: ""

variables:
  - group: aws-lab-credentials

  - name: AWS_REGION
    value: eu-central-1

  - name: ECR_REPO
    value: 895930755293.dkr.ecr.eu-central-1.amazonaws.com/ecs-fargate-lab-app

pool:
  vmImage: ubuntu-latest

stages:

# =================================================
# STAGE 1: Terraform PLAN
# =================================================
- stage: Plan
  displayName: "Terraform Plan"
  jobs:
  - job: TerraformPlan
    displayName: "Terraform Plan"
    steps:

    - bash: |
        set -e
        aws sts get-caller-identity
      displayName: "AWS auth check"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_REGION)

    - bash: |
        set -e
        if [ -z "${{ parameters.imageTag }}" ]; then
          echo "No tag specified, getting latest from ECR..."
          LATEST_TAG=$(aws ecr describe-images --repository-name ecs-fargate-lab-app --query 'sort_by(imageDetails,&imagePushedAt)[-1].imageTags[0]' --output text)
          echo "Latest tag: $LATEST_TAG"
          echo "##vso[task.setvariable variable=ECR_IMAGE_URI]$(ECR_REPO):$LATEST_TAG"
        else
          echo "Using specified tag: ${{ parameters.imageTag }}"
          echo "##vso[task.setvariable variable=ECR_IMAGE_URI]$(ECR_REPO):${{ parameters.imageTag }}"
        fi
      displayName: "Set ECR image URI"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_REGION)

    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "1.6.6"

    - bash: |
        set -e
        terraform init -upgrade -input=false
      displayName: "Terraform init (plan)"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_REGION)

    - bash: |
        set -e
        terraform plan -input=false \
          -var="ecr_image_uri=$(ECR_IMAGE_URI)"
      displayName: "Terraform plan"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_REGION)

# =================================================
# STAGE 2: Manual Approval
# =================================================
- stage: Approve
  displayName: "Manual Approval"
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - job: ManualApproval
    displayName: "Wait for approval"
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: "Approve to APPLY Terraform changes"
        onTimeout: reject
      timeoutInMinutes: 60

# =================================================
# STAGE 3: Terraform APPLY
# =================================================
- stage: Apply
  displayName: "Terraform Apply"
  dependsOn: Approve
  condition: succeeded()
  jobs:
  - job: TerraformApply
    displayName: "Terraform Apply"
    steps:

    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "1.6.6"

    - bash: |
        set -e
        terraform init -input=false
      displayName: "Terraform init (apply)"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_REGION)

    - bash: |
        set -e
        terraform apply -auto-approve \
          -var="ecr_image_uri=$(ECR_IMAGE_URI)"
      displayName: "Terraform apply"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_REGION)
