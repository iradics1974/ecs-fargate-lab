trigger: none

variables:
  - group: aws-lab-credentials

pool:
  vmImage: ubuntu-latest

stages:
# =================================================
# STAGE 1: Terraform PLAN
# =================================================
- stage: Plan
  displayName: "Terraform Plan"
  jobs:
  - job: TerraformPlan
    displayName: "Terraform Plan"
    steps:

    - bash: |
        set -e
        aws sts get-caller-identity
      displayName: "AWS auth check"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: eu-central-1

    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "latest"

    - bash: |
        set -e
        terraform init -input=false
      displayName: "Terraform init (plan)"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: eu-central-1

    - bash: |
        set -e
        terraform plan -input=false \
          -var="ecr_image_uri=$(ECR_IMAGE_URI)"
      displayName: "Terraform plan"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: eu-central-1

# =================================================
# STAGE 2: Manual Approval
# =================================================
- stage: Approve
  displayName: "Manual Approval"
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - job: ManualApproval
    displayName: "Wait for approval"
    pool: server
    steps:
    - task: ManualValidation@0
      inputs:
        instructions: "Approve to APPLY Terraform changes"
        onTimeout: reject
      timeoutInMinutes: 60

# =================================================
# STAGE 3: Terraform APPLY
# =================================================
- stage: Apply
  displayName: "Terraform Apply"
  dependsOn: Approve
  condition: succeeded()
  jobs:
  - job: TerraformApply
    displayName: "Terraform Apply"
    steps:

    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: "latest"

    - bash: |
        set -e
        terraform init -input=false
      displayName: "Terraform init (apply)"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: eu-central-1

    - bash: |
        set -e
        terraform apply -auto-approve \
          -var="ecr_image_uri=$(ECR_IMAGE_URI)"
      displayName: "Terraform apply"
      workingDirectory: terraform
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: eu-central-1
