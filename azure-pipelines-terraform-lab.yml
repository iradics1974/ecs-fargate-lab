# Terraform infra pipeline
# Cél:
# - külön fusson az app pipeline-tól
# - ne legyen interaktív
# - pipeline variable-ból kapja az image URI-t

trigger: none   # <-- nagyon fontos: nem indul el automatikusan

pool:
  vmImage: ubuntu-latest

variables:
  # AWS régió
  AWS_REGION: eu-central-1

  # Terraform working directory
  TF_WORKING_DIR: terraform

  # AWS credentialek variable groupból
  - group: aws-lab-credentials

steps:
  # 1️⃣ Repo checkout
  - checkout: self

  # 2️⃣ Terraform init
  - bash: |
      terraform init -upgrade
    displayName: "Terraform init"
    workingDirectory: $(TF_WORKING_DIR)
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(AWS_REGION)

  # 3️⃣ Terraform plan (nem interaktív)
  - bash: |
      terraform plan -input=false
    displayName: "Terraform plan"
    workingDirectory: $(TF_WORKING_DIR)
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(AWS_REGION)
      TF_VAR_ecr_image_uri: $(ECR_IMAGE_URI)

  # 4️⃣ Terraform apply (nem interaktív, automatikus)
  - bash: |
      terraform apply -auto-approve -input=false
    displayName: "Terraform apply"
    workingDirectory: $(TF_WORKING_DIR)
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_DEFAULT_REGION: $(AWS_REGION)
      TF_VAR_ecr_image_uri: $(ECR_IMAGE_URI)
